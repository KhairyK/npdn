let POPULAR_PACKAGES=[["react","latest","index.js"],["react","latest","jsx-runtime.js"],["vue","latest","dist/vue.esm.js"],["axios","latest","dist/axios.min.js"],["lodash","latest","lodash.js"],];export default{async fetch(e,t){let n=[];try{let a=new URL(e.url);if(!a.pathname.startsWith("/npm/"))return n.push("bad-route"),respondText("Use: /npm/<pkg>@<ver>/<file>",400,n);let r=a.pathname.replace("/npm/","").replace(/^\/+|\/+$/g,""),[s,...i]=r.split("/"),l=s.lastIndexOf("@");if(l<=0)return n.push("invalid-pkg@ver"),respondText("Invalid package@version format",400,n);let o=s.slice(0,l),u=s.slice(l+1),p=i.join("/"),c=a.searchParams.get("integrity"),f=a.searchParams.has("integrity")&&"all"!==c,h=a.searchParams.has("integrity")&&"all"===c,d=a.searchParams.has("meta"),g="";if(p){try{g=decodeURIComponent(p).replace(/^\.\/+/,"").replace(/\\/g,"/")}catch(m){return n.push("bad-percent-encoding"),respondText("Bad request (invalid percent-encoding)",400,n)}if(g.includes(".."))return n.push("path-traversal"),respondText("Forbidden path",403,n)}let $=g.endsWith(".map"),w=encodeURIComponent(o),y=`https://registry.npmjs.org/${w}`,T;try{let b=await fetch(y);if(!b.ok)return n.push("registry-404"),respondText("Package not found on registry",404,n);T=await b.json(),n.push("registry-fetch")}catch(C){return n.push("registry-fetch-failed"),respondText("Failed to fetch registry metadata",502,n)}let j=T["dist-tags"]||{},x=j[u]||u;if((!T.versions||!T.versions[x])&&(j.latest&&(x=j.latest),!T.versions||!T.versions[x]))return n.push("version-not-found"),respondText("Version not found",404,n);if(u!==x&&!h&&!d&&!g){let A=`/npm/${o}@${x}/${g}`,v=new Headers;return v.set("Location",A),v.set("Link",`<${A}>; rel="canonical"`),v.set("X-CDN-Trace",n.concat(["canonical-redirect"]).join(";")),new Response(null,{status:302,headers:v})}let R=T.versions[x],_=R&&R.dist&&R.dist.tarball||`https://registry.npmjs.org/${w}/-/${encodeURIComponent(getPkgBase(o))}-${x}.tgz`;if(!_)return n.push("no-tarball"),respondText("Tarball URL not found",502,n);let k=`${o}@${x}/${g}`,P=`${o}@${x}::integrity-manifest`;if("HEAD"===e.method){if(h){let N=await t.NPM_CACHE.get(P),X=new Headers;return X.set("Content-Type","application/json"),X.set("Access-Control-Allow-Origin","*"),X.set("X-Manifest-Cached",N?"true":"false"),X.set("X-CDN-Trace",n.concat(["head"]).join(";")),new Response(null,{status:200,headers:X})}let E=g?await t.NPM_CACHE.get(k,"arrayBuffer"):null,L=new Headers;if(L.set("Access-Control-Allow-Origin","*"),L.set("Content-Type",g?mimeTypeForPath(g):"application/json"),L.set("Cache-Control","public, max-age=31536000, immutable"),L.set("Accept-Ranges","bytes"),E){n.push("kv-hit"),L.set("X-Cache","HIT");let D=await computeETag(E);L.set("ETag",D)}else n.push("kv-miss"),L.set("X-Cache","MISS");return L.set("X-CDN-Trace",n.join(";")),new Response(null,{status:200,headers:L})}if(d&&!g){let F=R&&R.files?Object.keys(R.files).length:null,S={name:T.name,version:x,filesCount:F,hasTypes:!!R.types||!!R.typings,entry:{main:R&&R.main?R.main:null,module:R&&R.module?R.module:null,browser:R&&R.browser?R.browser:null},license:R&&R.license?R.license:null};return n.push("meta"),jsonResponse(S,{"X-CDN-Trace":n.join(";")})}if(h&&!g){let I=await t.NPM_CACHE.get(P);if(I)return n.push("manifest-kv-hit"),jsonResponse(JSON.parse(I),{"X-Manifest-Cached":"true","X-CDN-Trace":n.join(";")});let H;try{if(!(H=await fetch(_)).ok)return n.push("tarball-404"),respondText("Tarball not found on npm",404,n);n.push("tarball-fetch")}catch(B){return n.push("tarball-fetch-failed"),respondText("Failed fetching tarball",502,n)}let M;try{let z=H.body.pipeThrough(new DecompressionStream("gzip"));M=await streamToUint8Array(z)}catch(O){try{let U=await H.arrayBuffer();M=new Uint8Array(U)}catch(q){return n.push("tarball-read-fail"),respondText("Failed to read tarball bytes",502,n)}}let K=untar(M),V={};for(let W of K){let G=e$(W.name);if(!G)continue;let J=W.data instanceof Uint8Array?W.data:new Uint8Array(W.data);if(0===J.length)continue;let Q=await computeSRI(J.buffer);V[G]={integrity:Q,size:J.byteLength,mime:mimeTypeForPath(G)}}try{await t.NPM_CACHE.put(P,JSON.stringify(V),{expirationTtl:2592e3}),n.push("manifest-kv-put")}catch(Y){n.push("manifest-kv-put-failed"),console.warn("KV manifest put failed:",Y)}return n.push("manifest-generated"),jsonResponse(V,{"X-Manifest-Cached":"false","X-CDN-Trace":n.join(";")})}if(!g&&!h&&!d){let Z=[R&&R.module,R&&R.browser,R&&R.main,"dist/index.esm.js","dist/index.js","index.js",].filter(Boolean);if(!Z.length)return n.push("no-entry-candidates"),respondText("No entry file found",404,n);g=Z[0],n.push("smart-resolve:"+g)}if(!$){let ee=await t.NPM_CACHE.get(k,"arrayBuffer");if(ee){n.push("kv-hit");let et=new Uint8Array(ee),en=e.headers.get("If-None-Match"),ea=await computeETag(ee);if(en&&compareEtags(en,ea)){n.push("etag-match");let er=new Headers;return er.set("ETag",ea),er.set("Access-Control-Allow-Origin","*"),er.set("X-Cache","HIT"),er.set("X-CDN-Trace",n.join(";")),new Response(null,{status:304,headers:er})}let es=e.headers.get("Range");if(es){n.push("range-request");let ei=handleRangeRequest(et,es,ea,g,n);if(ei)return ei}if(f){let el=await computeSRI(et.buffer),eo=mimeTypeForPath(g);return n.push("integrity-json-kv"),jsonResponse({url:e.url,integrity:el,size:et.byteLength,mime:eo,cached:!0},{"X-CDN-Trace":n.join(";")})}return await makeFileResponse(e,et,g,!0,{ETag:ea,"Accept-Ranges":"bytes"},n)}n.push("kv-miss")}let eu;try{if(!(eu=await fetch(_)).ok)return n.push("tarball-404"),respondText("Tarball not found on npm",404,n);n.push("tarball-fetch")}catch(ep){return n.push("tarball-fetch-failed"),respondText("Failed fetching tarball",502,n)}let ec;try{let ef=eu.body.pipeThrough(new DecompressionStream("gzip"));ec=await streamToUint8Array(ef)}catch(eh){try{let ed=await eu.arrayBuffer();ec=new Uint8Array(ed)}catch(eg){return n.push("tarball-read-fail"),respondText("Failed to read tarball bytes",502,n)}}let em=untar(ec);function e$(e){return e.replace(/^package\//,"")}if($){let ew=em.find(e=>e$(e.name)===g);if(!ew)return n.push("map-not-found"),respondText(`.map file not found: ${g}`,404,n);let ey=ew.data instanceof Uint8Array?ew.data:new Uint8Array(ew.data);if(f){let eT=await computeSRI(ey.buffer),eb=mimeTypeForPath(g);return n.push("map-integrity"),jsonResponse({url:e.url,integrity:eT,size:ey.byteLength,mime:eb,cached:!1},{"X-CDN-Trace":n.join(";")})}return n.push("map-serve"),await makeFileResponse(e,ey,g,!1,{},n)}let eC=em.find(e=>e$(e.name)===g);if(!eC){let ej=em.find(e=>e$(e.name)===g+".map");if(ej)return n.push("file-not-found-but-map-exists"),jsonResponse({error:"Requested file not found, but a sourcemap exists",sourcemap:`/npm/${o}@${x}/${g}.map`},{"X-CDN-Trace":n.join(";")});return n.push("file-not-found"),respondText(`File not found in tarball: ${g}`,404,n)}let ex=eC.data instanceof Uint8Array?eC.data:new Uint8Array(eC.data);try{await t.NPM_CACHE.put(k,ex,{expirationTtl:31536e3}),n.push("kv-put")}catch(eA){n.push("kv-put-failed"),console.warn("KV put failed:",eA)}let ev=em.find(e=>e$(e.name)===g+".map"),eR={};ev&&(eR["X-Sourcemap-URL"]=`/npm/${o}@${x}/${g}.map`);let e2=await computeETag(ex.buffer);if(f){let e9=await computeSRI(ex.buffer),e_=mimeTypeForPath(g);return n.push("integrity-json-generated"),jsonResponse({url:e.url,integrity:e9,size:ex.byteLength,mime:e_,cached:!1},{"X-CDN-Trace":n.join(";")})}let e0=e.headers.get("If-None-Match");if(e0&&compareEtags(e0,e2)){n.push("etag-match-after-put");let ek=new Headers;return ek.set("ETag",e2),ek.set("Access-Control-Allow-Origin","*"),ek.set("X-CDN-Trace",n.join(";")),new Response(null,{status:304,headers:ek})}let eP=e.headers.get("Range");if(eP){n.push("range-request");let eN=handleRangeRequest(ex,eP,e2,g,n);if(eN)return eN}return await makeFileResponse(e,ex,g,!1,Object.assign({},eR,{ETag:e2,"Accept-Ranges":"bytes"}),n)}catch(eX){return console.error("Unhandled error:",eX),n.push("internal-error"),respondText("Internal Server Error",500,n)}},async scheduled(e,t,n){for(let[a,r,s]of POPULAR_PACKAGES){let i=`https://npdn.kyrt.my.id/npm/${a}@${r}/${s}`;n.waitUntil(fetch(i))}}};function getPkgBase(e){if(e.startsWith("@")){let t=e.split("/");return t[1]||e.replace("@","")}return e}function untar(e){let t=[],n=0;for(;n+512<=e.length;){let a=readStr(e,n,100).replace(/\0.*$/,"");if(!a)break;let r=readStr(e,n+124,12).replace(/\0.*$/,""),s=parseInt(r.trim()||"0",8),i=n+512,l=i+s;if(l>e.length)break;let o=e.slice(i,l);t.push({name:a,data:o}),n=i+512*Math.ceil(s/512)}return t}function readStr(e,t,n){return new TextDecoder().decode(e.slice(t,t+n))}async function streamToUint8Array(e){let t=e.getReader(),n=[],a=0;for(;;){let{done:r,value:s}=await t.read();if(r)break;n.push(s),a+=s.length}let i=new Uint8Array(a),l=0;for(let o of n)i.set(o,l),l+=o.length;return i}function mimeTypeForPath(e){let t=(e||"").split(".").pop().toLowerCase();return({js:"application/javascript",mjs:"application/javascript",cjs:"application/javascript",map:"application/json",json:"application/json",css:"text/css",html:"text/html",htm:"text/html",svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",avif:"image/avif",ico:"image/x-icon",txt:"text/plain",xml:"application/xml",wasm:"application/wasm",csv:"text/csv",ttf:"font/ttf",otf:"font/otf",woff:"font/woff",woff2:"font/woff2",eot:"application/vnd.ms-fontobject",mp3:"audio/mpeg",mp4:"video/mp4"})[t]||"application/octet-stream"}async function computeSRI(e){let t=await crypto.subtle.digest("SHA-512",e),n=arrayBufferToBase64(t);return`sha512-${n}`}function arrayBufferToBase64(e){let t=new Uint8Array(e),n="";for(let a=0;a<t.length;a+=32768)n+=String.fromCharCode.apply(null,t.subarray(a,a+32768));return btoa(n)}async function computeETag(e){let t;t=e instanceof ArrayBuffer?e:e.buffer?e.buffer:e;let n=await crypto.subtle.digest("SHA-256",t),a=bufferToHex(n);return`"${a}"`}function bufferToHex(e){let t=new Uint8Array(e),n="";for(let a=0;a<t.length;a++)n+=(t[a]+256).toString(16).substr(1);return n}function compareEtags(e,t){let n=e.split(",").map(e=>e.trim());return n.some(e=>e===t||e.replace(/^W\//,"")===t)}function handleRangeRequest(e,t,n,a,r=[]){let s=/^bytes=(\d*)-(\d*)$/.exec(t);if(!s)return null;let i=e.byteLength,l=""===s[1]?null:parseInt(s[1],10),o=""===s[2]?null:parseInt(s[2],10);if(null===l&&null===o)return null;if(null===l){let u=o;if(u<=0)return null;l=Math.max(0,i-u),o=i-1}else null===o&&(o=i-1);if(isNaN(l)||isNaN(o)||l>o||l<0||o>=i){let p=new Headers;return p.set("Content-Range",`bytes */${i}`),p.set("Accept-Ranges","bytes"),p.set("Access-Control-Allow-Origin","*"),p.set("X-CDN-Trace",r.concat(["range-416"]).join(";")),new Response(null,{status:416,headers:p})}let c=e.slice(l,o+1),f=new Headers;return f.set("Content-Type",mimeTypeForPath(a)),f.set("Content-Length",String(c.byteLength)),f.set("Content-Range",`bytes ${l}-${o}/${i}`),f.set("Accept-Ranges","bytes"),f.set("Cache-Control","public, max-age=31536000, immutable"),f.set("ETag",n),f.set("X-Partial-Content","true"),f.set("Access-Control-Allow-Origin","*"),f.set("X-CDN-Trace",r.concat(["range-206"]).join(";")),new Response(c,{status:206,headers:f})}async function makeFileResponse(e,t,n,a=!1,r={},s=[]){let i=new Headers;for(let l in i.set("Access-Control-Allow-Origin","*"),i.set("Content-Type",mimeTypeForPath(n)),i.set("Cache-Control","public, max-age=31536000, immutable"),i.set("X-Cache",a?"HIT":"MISS"),i.set("Accept-Ranges","bytes"),r)i.set(l,r[l]);let o=t instanceof Uint8Array?t:new Uint8Array(t),u=e.headers.get("Accept-Encoding")||"",p=(n||"").split(".").pop().toLowerCase(),c=new Set(["js","mjs","css","html","htm","json","xml","txt"]),f=u.includes("gzip")&&c.has(p);if(!f)return i.set("Content-Length",String(o.byteLength)),i.set("X-CDN-Trace",s.concat(["serve-raw"]).join(";")),new Response(o,{status:200,headers:i});try{let h=new Blob([o]).stream().pipeThrough(new CompressionStream("gzip"));return i.set("Content-Encoding","gzip"),i.delete("Content-Length"),i.append("Vary","Accept-Encoding"),i.set("X-CDN-Trace",s.concat(["gzip"]).join(";")),new Response(h,{status:200,headers:i})}catch(d){return i.set("Content-Length",String(o.byteLength)),i.set("X-CDN-Trace",s.concat(["gzip-failed","serve-raw"]).join(";")),new Response(o,{status:200,headers:i})}}function jsonResponse(e,t={}){let n=new Headers;for(let a in n.set("Content-Type","application/json"),n.set("Access-Control-Allow-Origin","*"),t)n.set(a,t[a]);return new Response(JSON.stringify(e),{status:200,headers:n})}function respondText(e,t=200,n=[]){let a=new Headers;return a.set("Content-Type","text/plain; charset=utf-8"),a.set("Access-Control-Allow-Origin","*"),a.set("X-CDN-Trace",n.join(";")),new Response(e,{status:t,headers:a})}function arrayBufferToBase64(e){let t=new Uint8Array(e),n="";for(let a=0;a<t.length;a+=32768)n+=String.fromCharCode.apply(null,t.subarray(a,a+32768));return btoa(n)}
